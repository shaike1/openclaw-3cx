version: '3.8'

# Full OpenClaw 3CX voice stack — everything in one compose file.
#
# ─────────────────────────────────────────────────────────────────
# PROFILES
# ─────────────────────────────────────────────────────────────────
# Default (no profile) — starts the core voice stack only.
# Use this on existing deployments where the SBC is already a host service
# and claude-api-server is already a host process.
#
#   docker compose up -d
#   docker compose up -d voice-app   (rebuild just the voice app)
#
# "full" profile — starts EVERYTHING including SBC and AI bridge containers.
# Use this on new deployments or after migrating away from host services.
# Before using: run ./sbc/provision.sh and stop the host sbc/api-server:
#
#   sudo systemctl stop 3cxsbc && sudo systemctl disable 3cxsbc
#   pkill -f "node.*server.js" || true   # stop host claude-api-server if running
#   docker compose --profile full up -d
#
# ─────────────────────────────────────────────────────────────────
# IMPORTANT: All containers use network_mode: host
# Docker bridge networking causes FreeSWITCH to advertise internal IPs
# in SDP, making RTP unreachable from external callers.
# ─────────────────────────────────────────────────────────────────

services:

  # ─────────────────────────────────────────
  # 3CX SmartSBC
  # Tunnels SIP signalling to 3CX Cloud.
  # Only starts with: --profile full
  # Config is provisioned once via: ./sbc/provision.sh
  # ARM64: x86_64 binary only — uncomment platform: linux/amd64 for QEMU emulation
  # ─────────────────────────────────────────
  sbc:
    profiles: ["full"]
    build: ./sbc
    container_name: 3cx-sbc
    restart: unless-stopped
    network_mode: host
    # platform: linux/amd64   # Uncomment on ARM64 for QEMU emulation
    volumes:
      - /etc/3cxsbc.conf:/etc/3cxsbc.conf

  # ─────────────────────────────────────────
  # drachtio SIP server
  # Handles SIP signalling (INVITE, REGISTER, etc.)
  # ARM64: ✅ official multi-arch image
  # ─────────────────────────────────────────
  drachtio:
    image: drachtio/drachtio-server:latest
    container_name: drachtio
    restart: unless-stopped
    network_mode: host
    command: >
      drachtio
      --contact "sip:*:5070;transport=tcp,udp"
      --external-ip ${EXTERNAL_IP}
      --secret ${DRACHTIO_SECRET:-cymru}
      --port 9022
      --loglevel info

  # ─────────────────────────────────────────
  # FreeSWITCH media server
  # Handles RTP audio, TTS playback, audio forking
  # ARM64: ⚠️  x86_64 only — uncomment platform: linux/amd64 for QEMU emulation
  # ─────────────────────────────────────────
  freeswitch:
    image: drachtio/drachtio-freeswitch-mrf:latest
    container_name: freeswitch
    restart: unless-stopped
    network_mode: host
    # platform: linux/amd64   # Uncomment on ARM64 for QEMU emulation
    command: >
      freeswitch
      --sip-port 5080
      --rtp-range-start 30000
      --rtp-range-end 30100
      --ext-rtp-ip ${EXTERNAL_IP}
      --ext-sip-ip ${EXTERNAL_IP}
      --advertise-external-ip

  # ─────────────────────────────────────────
  # OpenClaw API bridge
  # Translates voice-app queries → OpenClaw AI responses
  # Only starts with: --profile full
  # ARM64: ✅ node:20-slim is multi-arch
  # ─────────────────────────────────────────
  claude-api-server:
    profiles: ["full"]
    build: ./claude-api-server
    container_name: claude-api-server
    restart: unless-stopped
    network_mode: host
    environment:
      - OPENCLAW_HOST=${OPENCLAW_HOST}
      - OPENCLAW_PORT=${OPENCLAW_PORT:-18790}

  # ─────────────────────────────────────────
  # Voice application
  # SIP handler, TTS/STT, conversation loop, outbound calling API
  # ARM64: ✅ node:20-slim is multi-arch
  # ─────────────────────────────────────────
  voice-app:
    build: ./voice-app
    container_name: voice-app
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    volumes:
      - ./voice-app/audio:/app/audio
      - ./voice-app/config:/app/config
    depends_on:
      - drachtio
      - freeswitch
